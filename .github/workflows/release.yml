name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_INCREMENTAL: 0
  MAKEPAD: lines

jobs:
  build:
    name: Build - ${{ matrix.platform.os-name }} / ${{ matrix.platform.target }}
    runs-on: ${{ matrix.platform.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os-name: Linux
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary-name: meal_manager
            archive: tar.gz
          - os-name: Linux
            runs-on: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary-name: meal_manager
            archive: tar.gz
          - os-name: Linux
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-musl
            binary-name: meal_manager
            archive: tar.gz
          - os-name: Windows
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
            binary-name: meal_manager.exe
            archive: zip
          - os-name: macOS
            runs-on: macos-latest
            target: x86_64-apple-darwin
            binary-name: meal_manager
            archive: zip
          - os-name: macOS
            runs-on: macos-latest
            target: aarch64-apple-darwin
            binary-name: meal_manager
            archive: zip
          - os-name: WASM
            runs-on: ubuntu-latest
            target: wasm32-unknown-unknown
            binary-name: meal_manager.wasm
            archive: zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.platform.os-name == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            libsqlite3-dev \
            binfmt-support \
            libwayland-dev \
            libxkbcommon-dev \
            libxcb1-dev \
            libvulkan-dev \
            libx11-dev \
            libxcursor-dev \
            libasound2-dev \
            libpulse-dev \
            libfontconfig1-dev \
            musl-tools \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            ca-certificates

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-bindgen (WASM)
        if: contains(matrix.platform.target, 'wasm32')
        shell: bash
        run: |
          set -euo pipefail
          cargo install -f wasm-bindgen-cli || true

      - name: Install cargo-makepad (non-Windows, best-effort)
        if: matrix.platform.os-name != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cargo install --force --git https://github.com/makepad/makepad.git --branch dev cargo-makepad || true

      - name: Configure cross-linkers (Linux)
        if: matrix.platform.os-name == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.cargo
          printf '%s\n' \
            '[target.aarch64-unknown-linux-gnu]' 'linker = "aarch64-linux-gnu-gcc"' '' \
            '[target.x86_64-unknown-linux-musl]' 'linker = "musl-gcc"' \
            > ~/.cargo/config
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          export CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ matrix.platform.target }}"
          if [[ "${TARGET}" == *wasm32* || "${TARGET}" == *apple-ios* || "${TARGET}" == *linux-android* ]]; then
            if command -v cargo-makepad >/dev/null 2>&1; then
              cargo makepad build --release --target "${TARGET}" || cargo build --release --target "${TARGET}"
            else
              cargo build --release --target "${TARGET}"
            fi
          else
            cargo build --release --target "${TARGET}"
          fi

      - name: Package
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ matrix.platform.target }}"
          NAME="${{ matrix.platform.binary-name }}"
          mkdir -p release

          if [[ "${TARGET}" == *wasm32* ]]; then
            if ls target/${TARGET}/release/*.wasm >/dev/null 2>&1; then
              cp target/${TARGET}/release/*.wasm release/ || true
            fi
          else
            cp target/${TARGET}/release/${NAME} release/ 2>/dev/null || true
          fi

          if [[ "${{ matrix.platform.archive }}" == "zip" ]]; then
            cd release && zip -r ../meal_manager-${TARGET}.zip . || true
          else
            cd release && tar czf ../meal_manager-${TARGET}.tar.gz . || true
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: meal_manager-${{ matrix.platform.target }}
          path: |
            meal_manager-${{ matrix.platform.target }}.zip
            meal_manager-${{ matrix.platform.target }}.tar.gz

  ios-libs:
    name: Build iOS libraries (best-effort)
    runs-on: macos-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install iOS Rust targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,x86_64-apple-ios

      - name: Build iOS libraries
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --target aarch64-apple-ios || true
          cargo build --release --target x86_64-apple-ios || true
          mkdir -p meal_manager-ios
          cp -r target/aarch64-apple-ios/release/* meal_manager-ios/ || true
          cp -r target/x86_64-apple-ios/release/* meal_manager-ios/ || true
          tar czf meal_manager-ios-universal.tar.gz meal_manager-ios || true

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: meal_manager-ios
          path: meal_manager-ios-universal.tar.gz

  android-libs:
    name: Build Android libraries (best-effort)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Android Rust targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,x86_64-linux-android,armv7-linux-androideabi,i686-linux-android

      - name: Build Android libraries
        shell: bash
        run: |
          set -euo pipefail
          cargo install cargo-ndk || true
          cargo ndk -t aarch64-linux-android,x86_64-linux-android,armv7-linux-androideabi,i686-linux-android --release build || true
          mkdir -p meal_manager-android-libs
          cp -r target/*-linux-android/release/*.so meal_manager-android-libs/ 2>/dev/null || true
          tar czf meal_manager-android-libs.tar.gz meal_manager-android-libs || true

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: meal_manager-android
          path: meal_manager-android-libs.tar.gz

  release:
    name: Create Release
    needs: [build, ios-libs, android-libs]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            artifacts/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
