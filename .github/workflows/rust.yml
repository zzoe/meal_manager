name: Rust CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: rust-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  MAKEPAD: lines

jobs:
  build:
    name: Build & Test - ${{ matrix.platform.os-name }} / ${{ matrix.platform.target }}
    runs-on: ${{ matrix.platform.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os-name: Linux
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            run_tests: true
          - os-name: Linux
            runs-on: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            run_tests: false
          - os-name: Linux
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-musl
            run_tests: false
          - os-name: Windows
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
            run_tests: true
          - os-name: macOS
            runs-on: macos-latest
            target: x86_64-apple-darwin
            run_tests: true
          - os-name: macOS
            runs-on: macos-latest
            target: aarch64-apple-darwin
            run_tests: true
          - os-name: WASM
            runs-on: ubuntu-latest
            target: wasm32-unknown-unknown
            run_tests: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.platform.os-name == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            libsqlite3-dev \
            binfmt-support \
            libwayland-dev \
            libxkbcommon-dev \
            libxcb1-dev \
            libvulkan-dev \
            libx11-dev \
            libxcursor-dev \
            libasound2-dev \
            libpulse-dev \
            libfontconfig1-dev \
            musl-tools \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            ca-certificates

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-bindgen (WASM)
        if: contains(matrix.platform.target, 'wasm32')
        shell: bash
        run: |
          set -euo pipefail
          cargo install -f wasm-bindgen-cli || true

      - name: Configure cross-linkers (Linux)
        if: matrix.platform.os-name == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.cargo
          printf '%s\n' \
            '[target.aarch64-unknown-linux-gnu]' 'linker = "aarch64-linux-gnu-gcc"' '' \
            '[target.x86_64-unknown-linux-musl]' 'linker = "musl-gcc"' \
            > ~/.cargo/config
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          export CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc

      - name: Build
        shell: bash
        run: |
          set -euo pipefail
          cargo build --release --target "${{ matrix.platform.target }}"

      - name: Test
        if: ${{ matrix.platform.run_tests }}
        shell: bash
        run: |
          set -euo pipefail
          cargo test --verbose
