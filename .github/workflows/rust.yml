name: Rust CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: rust-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  MAKEPAD: lines

jobs:
  build:
    name: Build & Test - ${{ matrix.platform.os-name }} / ${{ matrix.platform.target }}
    runs-on: ${{ matrix.platform.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os-name: Linux
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            run_tests: true
          - os-name: Linux
            runs-on: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            run_tests: false
          - os-name: Linux
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-musl
            run_tests: false
          - os-name: Windows
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
            run_tests: true
          - os-name: macOS
            runs-on: macos-latest
            target: x86_64-apple-darwin
            run_tests: true
          - os-name: macOS
            runs-on: macos-latest
            target: aarch64-apple-darwin
            run_tests: true
          - os-name: WASM
            runs-on: ubuntu-latest
            target: wasm32-unknown-unknown
            run_tests: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.platform.os-name == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            libsqlite3-dev \
            binfmt-support \
            libwayland-dev \
            libxkbcommon-dev \
            libxcb1-dev \
            libvulkan-dev \
            libx11-dev \
            libxcursor-dev \
            libasound2-dev \
            libpulse-dev \
            libfontconfig1-dev \
            musl-tools \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            ca-certificates

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-bindgen (WASM)
        if: contains(matrix.platform.target, 'wasm32')
        shell: bash
        run: |
          set -euo pipefail
          cargo install -f wasm-bindgen-cli || true

      - name: Install cargo-makepad (non-Windows, best-effort)
        if: matrix.platform.os-name != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cargo install --force --git https://github.com/makepad/makepad.git --branch dev cargo-makepad || true

      - name: Configure cross-linkers (Linux)
        if: matrix.platform.os-name == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.cargo
          printf '%s\n' \
            '[target.aarch64-unknown-linux-gnu]' 'linker = "aarch64-linux-gnu-gcc"' '' \
            '[target.x86_64-unknown-linux-musl]' 'linker = "musl-gcc"' \
            > ~/.cargo/config
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          export CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc

      - name: Build (Unix)
        if: matrix.platform.os-name != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ matrix.platform.target }}"
          LOGFILE="build-${TARGET}.log"
          echo "Building for target: ${TARGET}" | tee -a "$LOGFILE"

          run_and_log() {
            echo "\$ $*" | tee -a "$LOGFILE"
            set -o pipefail
            "$@" 2>&1 | tee -a "$LOGFILE"
            return ${PIPESTATUS[0]}
          }

          if [[ "${TARGET}" == *wasm32* || "${TARGET}" == *apple-ios* || "${TARGET}" == *linux-android* ]]; then
            if command -v cargo-makepad >/dev/null 2>&1; then
              if ! run_and_log cargo makepad build --release --target "${TARGET}"; then
                run_and_log cargo build --release --target "${TARGET}"
              fi
            else
              run_and_log cargo build --release --target "${TARGET}"
            fi
          else
            run_and_log cargo build --release --target "${TARGET}"
          fi

      - name: Build (Windows)
        if: matrix.platform.os-name == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $target = '${{ matrix.platform.target }}'
          $logfile = "build-$target.log"
          Write-Host "Building for target: $target"
          if ($target -like '*wasm32*' -or $target -like '*apple-ios*' -or $target -like '*linux-android*') {
            if (Get-Command cargo-makepad -ErrorAction SilentlyContinue) {
              try {
                cargo makepad build --release --target $target 2>&1 | Tee-Object -FilePath $logfile
              } catch {
                cargo build --release --target $target 2>&1 | Tee-Object -FilePath $logfile
              }
            } else {
              cargo build --release --target $target 2>&1 | Tee-Object -FilePath $logfile
            }
          } else {
            cargo build --release --target $target 2>&1 | Tee-Object -FilePath $logfile
          }

      - name: Test
        if: ${{ matrix.platform.run_tests }}
        shell: bash
        run: |
          set -euo pipefail
          cargo test --verbose

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.platform.target }}
          path: build-${{ matrix.platform.target }}.log
