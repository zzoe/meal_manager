name: Rust CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    name: Build & Test - ${{ matrix.platform.os-name }} / ${{ matrix.platform.target }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os-name: Linux
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            run_tests: true
          - os-name: Linux
            runs-on: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            run_tests: false
          - os-name: Linux
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-musl
            run_tests: false
          - os-name: Windows
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
            run_tests: true
          - os-name: macOS
            runs-on: macos-latest
            target: x86_64-apple-darwin
            run_tests: true
          - os-name: macOS
            runs-on: macos-latest
            target: aarch64-apple-darwin
            run_tests: true
          - os-name: WASM
            runs-on: ubuntu-latest
            target: wasm32-unknown-unknown
            run_tests: false

    runs-on: ${{ matrix.platform.runs-on }}

    env:
      CARGO_TERM_COLOR: always
      CARGO_INCREMENTAL: 0
      MAKEPAD: lines

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        if: matrix.platform.os-name == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            libsqlite3-dev \
            binfmt-support \
            libwayland-dev \
            libxkbcommon-dev \
            libxcb1-dev \
            libvulkan-dev \
            libx11-dev \
            libxcursor-dev \
            libasound2-dev \
            libpulse-dev \
            libfontconfig1-dev \
            musl-tools \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            ca-certificates

      - name: Install Rust (stable) and requested target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install wasm tools (WASM)
        if: contains(matrix.platform.target, 'wasm32')
        shell: bash
        run: |
          set -euo pipefail
          cargo install -f wasm-bindgen-cli || true

      - name: Install cargo-makepad (non-Windows, best-effort)
        if: matrix.platform.os-name != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          echo "Installing cargo-makepad (dev branch) - best-effort"
          cargo install --force --git https://github.com/makepad/makepad.git --branch dev cargo-makepad || true

      - name: Ensure Rust targets exist for stable & nightly (Unix)
        if: matrix.platform.os-name != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          TARGET="${{ matrix.platform.target }}"
          echo "Ensuring rustup targets for both stable and nightly: ${TARGET}"
          rustup toolchain install nightly || true
          rustup target add --toolchain stable "${TARGET}" || true
          rustup target add --toolchain nightly "${TARGET}" || true

      - name: Ensure Rust targets exist for stable & nightly (Windows)
        if: matrix.platform.os-name == 'Windows'
        shell: pwsh
        run: |
          $target = '${{ matrix.platform.target }}'
          Write-Host "Ensuring rustup targets for both stable and nightly: $target"
          try { rustup toolchain install nightly } catch { Write-Host 'install nightly failed' }
          try { rustup target add --toolchain stable $target } catch { Write-Host 'target add stable failed' }
          try { rustup target add --toolchain nightly $target } catch { Write-Host 'target add nightly failed' }

      - name: Build (Unix)
        if: matrix.platform.os-name != 'Windows'
        shell: bash
        env:
          MAKEPAD: lines
        run: |
          set -euo pipefail
          TARGET="${{ matrix.platform.target }}"
          LOGFILE="build-${TARGET}.log"
          echo "Building for target: ${TARGET} on ${{ matrix.platform.os-name }}" | tee -a "$LOGFILE"

          # Helper that logs commands and preserves exit code
          run_and_log() {
            echo "\$ $*" | tee -a "$LOGFILE"
            set -o pipefail
            "$@" 2>&1 | tee -a "$LOGFILE"
            return ${PIPESTATUS[0]}
          }

          # Configure per-target linkers for common cross targets on Linux
          if [[ "${{ matrix.platform.os-name }}" == "Linux" ]]; then
            echo "Configuring per-target cargo linker settings for Linux" | tee -a "$LOGFILE"
            mkdir -p ~/.cargo
            printf '%s\n' \
              '[target.aarch64-unknown-linux-gnu]' 'linker = "aarch64-linux-gnu-gcc"' '' \
              '[target.x86_64-unknown-linux-musl]' 'linker = "musl-gcc"' \
              > ~/.cargo/config
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            export CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc
          fi

          # Prefer cargo-makepad when available (Makepad packaging helpers)
          if command -v cargo-makepad >/dev/null 2>&1; then
            echo "cargo-makepad available, attempting 'cargo makepad build'..." | tee -a "$LOGFILE"
            if run_and_log cargo makepad build --release --target "${TARGET}"; then
              echo "cargo-makepad build succeeded" | tee -a "$LOGFILE"
            else
              echo "cargo-makepad build failed; falling back to 'cargo build'" | tee -a "$LOGFILE"
              run_and_log cargo build --release --target "${TARGET}"
            fi
          else
            echo "cargo-makepad not found, using regular cargo build" | tee -a "$LOGFILE"
            run_and_log cargo build --release --target "${TARGET}"
          fi

      - name: Build (Windows)
        if: matrix.platform.os-name == 'Windows'
        shell: pwsh
        env:
          MAKEPAD: lines
        run: |
          $ErrorActionPreference = 'Stop'
          $target = '${{ matrix.platform.target }}'
          $logfile = "build-$target.log"
          Write-Host "Building for target: $target on Windows"

          if (Get-Command cargo-makepad -ErrorAction SilentlyContinue) {
            try {
              cargo makepad build --release --target $target 2>&1 | Tee-Object -FilePath $logfile
            } catch {
              Write-Host 'cargo-makepad failed; falling back to cargo build'
              cargo build --release --target $target 2>&1 | Tee-Object -FilePath $logfile
            }
          } else {
            cargo build --release --target $target 2>&1 | Tee-Object -FilePath $logfile
          }

      - name: Run tests
        if: ${{ matrix.platform.run_tests }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Running tests (if available for this target)"
          cargo test --verbose

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ matrix.platform.target }}
          path: build-${{ matrix.platform.target }}.log
